<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Tickets - Administradores</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .nav-link:hover { color: #3b82f6; transition: color 0.3s; }
        .table-container { max-height: 500px; overflow-y: auto; overflow-x: auto; }
        .edit-mode .editable { background-color: #f0f9ff; }
        .pagination { display: flex; justify-content: center; gap: 0.5rem; margin-top: 1rem; }
        .pagination button { padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background-color: #fff; cursor: pointer; }
        .pagination button:disabled { background-color: #e5e7eb; cursor: not-allowed; }
        .pagination button.active { background-color: #3b82f6; color: white; }
        @media (max-width: 1024px) {
            .table-container table { min-width: 100%; }
            .table-container th, .table-container td { min-width: 150px; white-space: nowrap; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <nav class="bg-white shadow-lg p-4 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="text-2xl font-bold text-gray-800">
                <i class="fas fa-ticket-alt mr-2 text-blue-500"></i> Tickets
            </div>
            <div class="hidden md:flex space-x-6">
                <a href="index.html" id="homeLink" class="nav-link text-gray-600">Inicio</a>
                <a href="client.html" id="clientLink" class="nav-link text-gray-600 hidden">Clientes</a>
                <a href="admin.html" id="adminLink" class="nav-link text-gray-600 hidden">Administradores</a>
                <a href="profile.html" id="profileLink" class="nav-link text-gray-600 hidden">Perfil</a>
                <a href="#" id="logoutLink" class="nav-link text-red-500 hidden">Cerrar Sesión</a>
            </div>
            <div class="md:hidden">
                <button id="menuToggle" class="text-gray-600 focus:outline-none">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
            </div>
        </div>
        <div id="mobileMenu" class="hidden md:hidden bg-white shadow-lg p-4">
            <a href="index.html" id="homeLinkMobile" class="block py-2 text-gray-600 nav-link">Inicio</a>
            <a href="client.html" id="clientLinkMobile" class="block py-2 text-gray-600 nav-link hidden">Clientes</a>
            <a href="admin.html" id="adminLinkMobile" class="block py-2 text-gray-600 nav-link hidden">Administradores</a>
            <a href="profile.html" id="profileLinkMobile" class="block py-2 text-gray-600 nav-link hidden">Perfil</a>
            <a href="#" id="logoutLinkMobile" class="block py-2 text-red-500 nav-link hidden">Cerrar Sesión</a>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto py-10 px-4">
        <div class="bg-white shadow-xl rounded-lg p-6 fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-tools mr-2 text-blue-500"></i> Gestión de Tickets
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label for="statusFilter" class="block text-gray-700 font-medium mb-2">Estado</label>
                    <select id="statusFilter" class="w-full p-2 border rounded-lg">
                        <option value="">Todos</option>
                        <option value="nuevo">Nuevo</option>
                        <option value="en progreso">En Progreso</option>
                        <option value="resuelto">Resuelto</option>
                    </select>
                </div>
                <div>
                    <label for="priorityFilter" class="block text-gray-700 font-medium mb-2">Prioridad</label>
                    <select id="priorityFilter" class="w-full p-2 border rounded-lg">
                        <option value="">Todas</option>
                        <option value="baja">Baja</option>
                        <option value="media">Media</option>
                        <option value="alta">Alta</option>
                    </select>
                </div>
                <div>
                    <label for="categoryFilter" class="block text-gray-700 font-medium mb-2">Categoría</label>
                    <select id="categoryFilter" class="w-full p-2 border rounded-lg">
                        <option value="">Todas</option>
                        <option value="Soporte Técnico">Soporte Técnico</option>
                        <option value="Facturación">Facturación</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
            </div>
            <p id="adminMessage" class="text-sm text-center mb-4 hidden"></p>
            <div class="table-container">
                <table class="w-full text-left text-gray-700">
                    <thead class="bg-gray-200 sticky top-0">
                        <tr>
                            <th class="p-3">ID</th>
                            <th class="p-3">Título</th>
                            <th class="p-3">Descripción</th>
                            <th class="p-3">Estado</th>
                            <th class="p-3">Prioridad</th>
                            <th class="p-3">Categoría</th>
                            <th class="p-3">Usuario (Nombre)</th>
                            <th class="p-3">Correo</th>
                            <th class="p-3">Asignado a</th>
                            <th class="p-3">Creado</th>
                            <th class="p-3">Actualizado</th>
                            <th class="p-3">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="ticketTable"></tbody>
                </table>
            </div>
            <div id="pagination" class="pagination"></div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBZePWGqYeBApjnH5TM288hK4FrUqzj8lg",
            authDomain: "tickets2-5074d.firebaseapp.com",
            projectId: "tickets2-5074d",
            storageBucket: "tickets2-5074d.firebasestorage.app",
            messagingSenderId: "896259008791",
            appId: "1:896259008791:web:d004d06ff1dcd7701aaf52"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            const ticketTable = document.getElementById('ticketTable');
            const adminMessage = document.getElementById('adminMessage');
            const statusFilter = document.getElementById('statusFilter');
            const priorityFilter = document.getElementById('priorityFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            const clientLink = document.getElementById('clientLink');
            const adminLink = document.getElementById('adminLink');
            const profileLink = document.getElementById('profileLink');
            const logoutLink = document.getElementById('logoutLink');
            const clientLinkMobile = document.getElementById('clientLinkMobile');
            const adminLinkMobile = document.getElementById('adminLinkMobile');
            const profileLinkMobile = document.getElementById('profileLinkMobile');
            const logoutLinkMobile = document.getElementById('logoutLinkMobile');
            const menuToggle = document.getElementById('menuToggle');
            const mobileMenu = document.getElementById('mobileMenu');
            const pagination = document.getElementById('pagination');

            if (menuToggle) {
                menuToggle.addEventListener('click', () => {
                    mobileMenu.classList.toggle('hidden');
                });
            }

            if (logoutLink) logoutLink.addEventListener('click', () => signOut(auth).then(() => window.location.href = 'index.html'));
            if (logoutLinkMobile) logoutLinkMobile.addEventListener('click', () => signOut(auth).then(() => window.location.href = 'index.html'));

            let allTickets = [];
            let admins = [];
            let editedTickets = {};
            let currentPage = 1;
            const ticketsPerPage = 10;

            window.editTicket = function(ticketId) {
                editedTickets[ticketId] = true;
                applyFiltersAndPagination();
            };

            window.saveChanges = function(ticketId) {
                saveChanges(ticketId);
            };

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    try {
                        const userDoc = await getDoc(doc(db, 'users', user.uid));
                        const userData = userDoc.exists() ? userDoc.data() : {};
                        const role = userData.role || 'client';
                        console.log('Rol del usuario en admin.html:', role);

                        clientLink.classList.toggle('hidden', role !== 'client');
                        adminLink.classList.toggle('hidden', role !== 'admin');
                        profileLink.classList.remove('hidden');
                        logoutLink.classList.remove('hidden');
                        clientLinkMobile.classList.toggle('hidden', role !== 'client');
                        adminLinkMobile.classList.toggle('hidden', role !== 'admin');
                        profileLinkMobile.classList.remove('hidden');
                        logoutLinkMobile.classList.remove('hidden');

                        if (role !== 'admin') window.location.href = 'index.html';

                        await loadAdmins();
                        loadTickets();
                    } catch (error) {
                        console.error('Error al obtener el rol del usuario:', error);
                        showMessage('Error al verificar permisos: ' + error.message, 'text-red-500');
                    }
                } else {
                    window.location.href = 'index.html';
                }
            });

            async function loadAdmins() {
                try {
                    const usersSnapshot = await getDocs(collection(db, 'users'));
                    admins = usersSnapshot.docs
                        .filter(doc => doc.data().role === 'admin')
                        .map(doc => ({ id: doc.id, email: doc.data().email || 'Sin email' }));
                    console.log('Administradores cargados:', admins);
                } catch (error) {
                    console.error('Error al cargar administradores:', error);
                    showMessage('Error al cargar administradores: ' + error.message, 'text-red-500');
                }
            }

            async function loadTickets() {
                onSnapshot(collection(db, 'tickets'), async (snapshot) => {
                    console.log('Tickets recibidos:', snapshot.docs.length);
                    allTickets = await Promise.all(snapshot.docs.map(async document => {
                        const data = document.data();
                        console.log('Ticket:', document.id, data);
                        try {
                            const userDoc = await getDoc(doc(db, 'users', data.user_id));
                            const userData = userDoc.exists() ? userDoc.data() : { username: 'Desconocido', email: 'Sin correo' };
                            return { 
                                id: document.id, 
                                title: data.title || 'Sin título', 
                                description: data.description || 'Sin descripción', 
                                status: data.status || 'nuevo', 
                                priority: data.priority || 'media', 
                                category: data.category || 'Otros', 
                                created_at: data.created_at || new Date().toISOString(), 
                                updated_at: data.updated_at || new Date().toISOString(), 
                                user_id: data.user_id || '', 
                                assigned_to: data.assigned_to || '', 
                                username: userData.username || 'Desconocido', 
                                email: userData.email || 'Sin correo' 
                            };
                        } catch (error) {
                            console.error('Error al cargar usuario para ticket:', document.id, error);
                            return { 
                                id: document.id, 
                                title: data.title || 'Sin título', 
                                description: data.description || 'Sin descripción', 
                                status: data.status || 'nuevo', 
                                priority: data.priority || 'media', 
                                category: data.category || 'Otros', 
                                created_at: data.created_at || new Date().toISOString(), 
                                updated_at: data.updated_at || new Date().toISOString(), 
                                user_id: data.user_id || '', 
                                assigned_to: data.assigned_to || '', 
                                username: 'Desconocido', 
                                email: 'Sin correo' 
                            };
                        }
                    }));
                    applyFiltersAndPagination();
                }, (error) => {
                    console.error('Error al cargar tickets:', error);
                    showMessage('Error al cargar tickets: ' + error.message, 'text-red-500');
                });
            }

            function applyFiltersAndPagination() {
                const status = statusFilter ? statusFilter.value : '';
                const priority = priorityFilter ? priorityFilter.value : '';
                const category = categoryFilter ? categoryFilter.value : '';

                const filteredTickets = allTickets.filter(ticket => {
                    return (!status || ticket.status === status) &&
                           (!priority || ticket.priority === priority) &&
                           (!category || ticket.category === category);
                });

                console.log('Tickets filtrados:', filteredTickets.length);
                displayPage(filteredTickets, currentPage);
                updatePagination(filteredTickets);
            }

            function displayPage(tickets, page) {
                ticketTable.innerHTML = '';
                const start = (page - 1) * ticketsPerPage;
                const end = start + ticketsPerPage;
                const paginatedTickets = tickets.slice(start, end);

                paginatedTickets.forEach(ticket => {
                    const isEditing = editedTickets[ticket.id] || false;
                    const row = `
                        <tr class="border-b ${isEditing ? 'edit-mode' : ''}" data-id="${ticket.id}">
                            <td class="p-3">${ticket.id}</td>
                            <td class="p-3">${ticket.title}</td>
                            <td class="p-3">${ticket.description}</td>
                            <td class="p-3">
                                <select class="editable p-1 border rounded" ${isEditing ? '' : 'disabled'}>
                                    <option value="nuevo" ${ticket.status === 'nuevo' ? 'selected' : ''}>Nuevo</option>
                                    <option value="en progreso" ${ticket.status === 'en progreso' ? 'selected' : ''}>En Progreso</option>
                                    <option value="resuelto" ${ticket.status === 'resuelto' ? 'selected' : ''}>Resuelto</option>
                                </select>
                            </td>
                            <td class="p-3">
                                <select class="editable p-1 border rounded" ${isEditing ? '' : 'disabled'}>
                                    <option value="baja" ${ticket.priority === 'baja' ? 'selected' : ''}>Baja</option>
                                    <option value="media" ${ticket.priority === 'media' ? 'selected' : ''}>Media</option>
                                    <option value="alta" ${ticket.priority === 'alta' ? 'selected' : ''}>Alta</option>
                                </select>
                            </td>
                            <td class="p-3">${ticket.category}</td>
                            <td class="p-3">${ticket.username}</td>
                            <td class="p-3">${ticket.email}</td>
                            <td class="p-3">
                                <select class="editable p-1 border rounded" ${isEditing ? '' : 'disabled'}>
                                    <option value="">Sin asignar</option>
                                    ${admins.map(admin => `<option value="${admin.id}" ${ticket.assigned_to === admin.id ? 'selected' : ''}>${admin.email}</option>`).join('')}
                                </select>
                            </td>
                            <td class="p-3">${ticket.created_at ? new Date(ticket.created_at).toLocaleString() : 'N/A'}</td>
                            <td class="p-3">${ticket.updated_at ? new Date(ticket.updated_at).toLocaleString() : 'N/A'}</td>
                            <td class="p-3">
                                ${isEditing ? 
                                    `<button class="bg-green-500 text-white p-2 rounded hover:bg-green-600 transition duration-300 save-btn" data-id="${ticket.id}"><i class="fas fa-save mr-1"></i> Guardar</button>` :
                                    `<button class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition duration-300 edit-btn" data-id="${ticket.id}"><i class="fas fa-edit mr-1"></i> Editar</button>`
                                }
                            </td>
                        </tr>
                    `;
                    ticketTable.insertAdjacentHTML('beforeend', row);
                });
                if (paginatedTickets.length === 0) {
                    ticketTable.innerHTML = '<tr><td colspan="12" class="p-3 text-center text-gray-500">No hay tickets que coincidan con los filtros.</td></tr>';
                }

                // Añadir eventos dinámicos después de renderizar
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const ticketId = btn.getAttribute('data-id');
                        editTicket(ticketId);
                    });
                });
                document.querySelectorAll('.save-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const ticketId = btn.getAttribute('data-id');
                        saveChanges(ticketId);
                    });
                });
            }

            function updatePagination(tickets) {
                const totalPages = Math.ceil(tickets.length / ticketsPerPage);
                pagination.innerHTML = '';

                const prevButton = document.createElement('button');
                prevButton.textContent = 'Anterior';
                prevButton.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        displayPage(tickets, currentPage);
                        updatePagination(tickets);
                    }
                });
                prevButton.disabled = currentPage === 1;
                pagination.appendChild(prevButton);

                for (let i = 1; i <= totalPages; i++) {
                    const pageButton = document.createElement('button');
                    pageButton.textContent = i;
                    pageButton.classList.toggle('active', i === currentPage);
                    pageButton.addEventListener('click', () => {
                        currentPage = i;
                        displayPage(tickets, currentPage);
                        updatePagination(tickets);
                    });
                    pagination.appendChild(pageButton);
                }

                const nextButton = document.createElement('button');
                nextButton.textContent = 'Siguiente';
                nextButton.addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        displayPage(tickets, currentPage);
                        updatePagination(tickets);
                    }
                });
                nextButton.disabled = currentPage === totalPages;
                pagination.appendChild(nextButton);
            }

            function editTicket(ticketId) {
                editedTickets[ticketId] = true;
                applyFiltersAndPagination();
            }

            async function saveChanges(ticketId) {
                const row = document.querySelector(`tr[data-id="${ticketId}"]`);
                if (!row) {
                    showMessage('No se encontró la fila del ticket.', 'text-red-500');
                    return;
                }

                const statusSelect = row.querySelector('.editable:nth-child(4)');
                const prioritySelect = row.querySelector('.editable:nth-child(5)');
                const assignedSelect = row.querySelector('.editable:nth-child(9)');

                if (!statusSelect || !prioritySelect || !assignedSelect) {
                    showMessage('No se encontraron los campos editables.', 'text-red-500');
                    console.error('Faltan selectores en la fila:', row);
                    return;
                }

                const changes = {
                    status: statusSelect.value,
                    priority: prioritySelect.value,
                    assigned_to: assignedSelect.value || '',
                    updated_at: new Date().toISOString()
                };

                try {
                    const ticketRef = doc(db, 'tickets', ticketId);
                    await updateDoc(ticketRef, changes);
                    showMessage('¡Cambios guardados con éxito!', 'text-green-500');
                    editedTickets[ticketId] = false;
                    applyFiltersAndPagination();
                } catch (error) {
                    showMessage(`Error al guardar cambios: ${error.message}`, 'text-red-500');
                    console.error('Error al guardar cambios:', error);
                }
            }

            async function updateTicket(ticketId, field, value) {
                try {
                    const ticketRef = doc(db, 'tickets', ticketId);
                    await updateDoc(ticketRef, {
                        [field]: value,
                        updated_at: new Date().toISOString()
                    });
                    showMessage('¡Ticket actualizado con éxito!', 'text-green-500');
                } catch (error) {
                    showMessage(`Error: ${error.message}`, 'text-red-500');
                }
            }

            if (statusFilter) statusFilter.addEventListener('change', applyFiltersAndPagination);
            if (priorityFilter) priorityFilter.addEventListener('change', applyFiltersAndPagination);
            if (categoryFilter) categoryFilter.addEventListener('change', applyFiltersAndPagination);

            function showMessage(text, className) {
                adminMessage.textContent = text;
                adminMessage.className = `text-sm text-center mb-4 ${className}`;
                adminMessage.classList.remove('hidden');
                setTimeout(() => adminMessage.classList.add('hidden'), 3000);
            }
        });
    </script>
</body>
</html>
