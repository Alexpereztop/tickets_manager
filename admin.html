<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBZePWGqYeBApjnH5TM288hK4FrUqzj8lg",
        authDomain: "tickets2-5074d.firebaseapp.com",
        projectId: "tickets2-5074d",
        storageBucket: "tickets2-5074d.firebasestorage.app",
        messagingSenderId: "896259008791",
        appId: "1:896259008791:web:d004d06ff1dcd7701aaf52"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ticketTable = document.getElementById('ticketTable');
    const adminMessage = document.getElementById('adminMessage');
    const statusFilter = document.getElementById('statusFilter');
    const priorityFilter = document.getElementById('priorityFilter');
    const categoryFilter = document.getElementById('categoryFilter');
    const clientLink = document.getElementById('clientLink');
    const adminLink = document.getElementById('adminLink');
    const profileLink = document.getElementById('profileLink');
    const logoutLink = document.getElementById('logoutLink');
    const clientLinkMobile = document.getElementById('clientLinkMobile');
    const adminLinkMobile = document.getElementById('adminLinkMobile');
    const profileLinkMobile = document.getElementById('profileLinkMobile');
    const logoutLinkMobile = document.getElementById('logoutLinkMobile');
    const menuToggle = document.getElementById('menuToggle');
    const mobileMenu = document.getElementById('mobileMenu');

    menuToggle.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
    });

    logoutLink.addEventListener('click', () => signOut(auth).then(() => window.location.href = 'index.html'));
    logoutLinkMobile.addEventListener('click', () => signOut(auth).then(() => window.location.href = 'index.html'));

    let allTickets = [];
    let admins = [];

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            const userData = userDoc.exists() ? userDoc.data() : {};
            const role = userData.role || 'client';

            clientLink.classList.toggle('hidden', role !== 'client');
            adminLink.classList.toggle('hidden', role !== 'admin');
            profileLink.classList.remove('hidden');
            logoutLink.classList.remove('hidden');
            clientLinkMobile.classList.toggle('hidden', role !== 'client');
            adminLinkMobile.classList.toggle('hidden', role !== 'admin');
            profileLinkMobile.classList.remove('hidden');
            logoutLinkMobile.classList.remove('hidden');

            if (role !== 'admin') window.location.href = 'index.html';

            await loadAdmins();
            loadTickets();
        } else {
            window.location.href = 'index.html';
        }
    });

    async function loadAdmins() {
        const usersSnapshot = await getDocs(collection(db, 'users'));
        admins = usersSnapshot.docs
            .filter(doc => doc.data().role === 'admin')
            .map(doc => ({ id: doc.id, email: doc.data().email }));
    }

    function loadTickets() {
        onSnapshot(collection(db, 'tickets'), (snapshot) => {
            console.log('Tickets recibidos:', snapshot.docs.length);
            allTickets = snapshot.docs.map(doc => {
                const data = doc.data();
                console.log('Ticket:', doc.id, data);
                return { id: doc.id, ...data };
            });
            applyFilters();
        }, (error) => {
            console.error('Error al cargar tickets:', error);
            showMessage('Error al cargar tickets: ' + error.message, 'text-red-500');
        });
    }

    function applyFilters() {
        const status = statusFilter.value;
        const priority = priorityFilter.value;
        const category = categoryFilter.value;

        const filteredTickets = allTickets.filter(ticket => {
            return (!status || ticket.status === status) &&
                   (!priority || ticket.priority === priority) &&
                   (!category || ticket.category === category);
        });

        ticketTable.innerHTML = '';
        console.log('Tickets filtrados:', filteredTickets.length);
        filteredTickets.forEach(ticket => {
            const row = `
                <tr class="border-b">
                    <td class="p-3">${ticket.id}</td>
                    <td class="p-3">${ticket.title || 'Sin título'}</td>
                    <td class="p-3">${ticket.description || 'Sin descripción'}</td>
                    <td class="p-3">
                        <select onchange="updateTicket('${ticket.id}', 'status', this.value)" class="p-1 border rounded">
                            <option value="nuevo" ${ticket.status === 'nuevo' ? 'selected' : ''}>Nuevo</option>
                            <option value="en progreso" ${ticket.status === 'en progreso' ? 'selected' : ''}>En Progreso</option>
                            <option value="resuelto" ${ticket.status === 'resuelto' ? 'selected' : ''}>Resuelto</option>
                        </select>
                    </td>
                    <td class="p-3">
                        <select onchange="updateTicket('${ticket.id}', 'priority', this.value)" class="p-1 border rounded">
                            <option value="baja" ${ticket.priority === 'baja' ? 'selected' : ''}>Baja</option>
                            <option value="media" ${ticket.priority === 'media' ? 'selected' : ''}>Media</option>
                            <option value="alta" ${ticket.priority === 'alta' ? 'selected' : ''}>Alta</option>
                        </select>
                    </td>
                    <td class="p-3">
                        <select onchange="updateTicket('${ticket.id}', 'assigned_to', this.value)" class="p-1 border rounded">
                            <option value="">Sin asignar</option>
                            ${admins.map(admin => `<option value="${admin.id}" ${ticket.assigned_to === admin.id ? 'selected' : ''}>${admin.email}</option>`).join('')}
                        </select>
                    </td>
                    <td class="p-3">${ticket.created_at ? new Date(ticket.created_at).toLocaleString() : 'N/A'}</td>
                    <td class="p-3">${ticket.updated_at ? new Date(ticket.updated_at).toLocaleString() : 'N/A'}</td>
                </tr>
            `;
            ticketTable.insertAdjacentHTML('beforeend', row);
        });
        if (filteredTickets.length === 0) {
            ticketTable.innerHTML = '<tr><td colspan="8" class="p-3 text-center text-gray-500">No hay tickets que coincidan con los filtros.</td></tr>';
        }
    }

    async function updateTicket(ticketId, field, value) {
        try {
            const ticketRef = doc(db, 'tickets', ticketId);
            await updateDoc(ticketRef, {
                [field]: value,
                updated_at: new Date().toISOString()
            });
            showMessage('¡Ticket actualizado con éxito!', 'text-green-500');
        } catch (error) {
            showMessage(`Error: ${error.message}`, 'text-red-500');
        }
    }

    statusFilter.addEventListener('change', applyFilters);
    priorityFilter.addEventListener('change', applyFilters);
    categoryFilter.addEventListener('change', applyFilters);

    function showMessage(text, className) {
        adminMessage.textContent = text;
        adminMessage.className = `text-sm text-center mb-4 ${className}`;
        adminMessage.classList.remove('hidden');
        setTimeout(() => adminMessage.classList.add('hidden'), 3000);
    }
</script>
